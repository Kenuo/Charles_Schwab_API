<!DOCTYPE html>
<html>
<head>
    <title>Order Form with Tables</title>
    <script>
        function addCheckboxes() {
            fetch('http://127.0.0.1:5000/getAccountNames')
                .then(response => response.json())
                .then(accountNamesDict => {
                    const accountNames = Object.keys(accountNamesDict);
                    const form = document.getElementById('orderForm');
    
                    // Clear existing checkboxes to avoid duplication
                    const existingCheckboxes = form.querySelectorAll('input[name="accounts"]');
                    existingCheckboxes.forEach(checkbox => checkbox.parentElement.remove());
    
                    const fragment = document.createDocumentFragment();
                    accountNames.forEach(accountName => {
                        const label = document.createElement('label');
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.name = 'accounts';
                        checkbox.value = accountName;
                        checkbox.checked = isCheckboxChecked(accountName);  // Restore checkbox state from local storage
                        checkbox.onchange = () => {
                            toggleTableVisibility(accountName);
                            saveCheckboxState(accountName, checkbox.checked);
                        };
                        label.appendChild(checkbox);
                        label.appendChild(document.createTextNode(accountName));
                        fragment.appendChild(label);
                        fragment.appendChild(document.createElement('br'));
                    });
    
                    form.insertBefore(fragment, form.firstChild);
                })
                .catch(error => console.error('Failed to fetch account names:', error));
        }
    
        function isCheckboxChecked(accountName) {
            return localStorage.getItem(`checkbox_${accountName}`) === 'true';
        }
    
        function saveCheckboxState(accountName, isChecked) {
            localStorage.setItem(`checkbox_${accountName}`, isChecked);
        }
    
        function toggleTableVisibility(accountName) {
            const table = document.getElementById(`table_${accountName}`);
            if (table) {
                table.style.display = table.style.display === 'none' ? 'table' : 'none';
            }
        }
    
        function loadOrderTables() {
            fetch('http://127.0.0.1:5000/getAccountNames')
                .then(response => response.json())
                .then(accountNamesDict => {
                    const accountNames = Object.keys(accountNamesDict);
                    return fetch('http://127.0.0.1:5000/getOrder')
                        .then(response => response.json())
                        .then(data => {
                            const orderDiv = document.getElementById('orderTablesDiv');
                            orderDiv.innerHTML = ''; // Clear existing order tables
    
                            data.forEach((order, index) => {
                                const table = document.createElement('table');
                                table.border = 1;
    
                                const headerRow = document.createElement('tr');
                                const headerCell = document.createElement('th');
                                headerCell.colSpan = 5;
                                headerCell.textContent = accountNames[index] || `Account ${index + 1}`;
                                headerRow.appendChild(headerCell);
                                table.appendChild(headerRow);
    
                                const headers = ['Tinker', 'Quantity', 'Price', 'Instruction', 'Status'];
                                const headerRow2 = document.createElement('tr');
                                headers.forEach(headerText => {
                                    const header = document.createElement('th');
                                    header.textContent = headerText;
                                    headerRow2.appendChild(header);
                                });
                                table.appendChild(headerRow2);
    
                                order.forEach(item => {
                                    const row = document.createElement('tr');
                                    const tinkerCell = document.createElement('td');
                                    tinkerCell.textContent = item.orderLegCollection[0].instrument.symbol;
                                    row.appendChild(tinkerCell);
    
                                    const quantityCell = document.createElement('td');
                                    quantityCell.textContent = item.quantity;
                                    row.appendChild(quantityCell);
    
                                    const priceCell = document.createElement('td');
                                    priceCell.textContent = item.price;
                                    row.appendChild(priceCell);
    
                                    const instrCell = document.createElement('td');
                                    instrCell.textContent = item.orderLegCollection[0].instruction;
                                    row.appendChild(instrCell);
    
                                    const statCell = document.createElement('td');
                                    statCell.textContent = item.status;
                                    row.appendChild(statCell);
    
                                    table.appendChild(row);
                                });
    
                                orderDiv.appendChild(table);
                            });
                        })
                        .catch(error => alert('Failed to fetch orders: ' + error));
                })
                .catch(error => alert('Failed to fetch account names: ' + error));
        }
    
        function addQuantityPriceTables() {
            fetch('http://127.0.0.1:5000/getAccountNames')
                .then(response => response.json())
                .then(accountNamesDict => {
                    const accountNames = Object.keys(accountNamesDict);
                    const form = document.getElementById('orderForm');
    
                    fetch('http://127.0.0.1:5000/getAccountInfo')
                        .then(response => response.json())
                        .then(accountInfoDict => {
                            // Clear existing quantity/price tables to avoid duplication
                            const existingTables = form.querySelectorAll('table[id^="table_"]');
                            existingTables.forEach(table => table.remove());
    
                            accountNames.forEach((accountName, index) => {
                                // Check if the table already exists
                                let existingTable = document.getElementById(`table_${accountName}`);
                                if (existingTable) {
                                    return; // Skip creating a new table if it already exists
                                }
    
                                const table = document.createElement('table');
                                table.border = 1;
                                table.id = `table_${accountName}`;
                                table.style.display = isCheckboxChecked(accountName) ? 'table' : 'none'; // Show or hide based on local storage
    
                                const headerRow = document.createElement('tr');
                                const headerCell = document.createElement('th');
                                headerCell.colSpan = 4;
                                headerCell.textContent = `${accountName} - Quantity, Price, and Balance`;
                                headerRow.appendChild(headerCell);
                                table.appendChild(headerRow);
    
                                const headerRow2 = document.createElement('tr');
                                const headers = ['Quantity', 'Price per item', 'Total Cost', 'Account Balance'];
                                headers.forEach(headerText => {
                                    const header = document.createElement('th');
                                    header.textContent = headerText;
                                    headerRow2.appendChild(header);
                                });
                                table.appendChild(headerRow2);
    
                                const row = document.createElement('tr');
                                const quantityCell = document.createElement('td');
                                const priceCell = document.createElement('td');
                                const totalCell = document.createElement('td');
                                const balanceCell = document.createElement('td');
    
                                const quantityInput = document.createElement('input');
                                quantityInput.type = 'number';
                                quantityInput.name = `${accountName}_quantity`;
                                quantityInput.id = `quantity_${index}`;
                                quantityInput.value = 0;
                                quantityInput.required = true;
                                quantityInput.oninput = () => calculateTotal(index);
                                quantityCell.appendChild(quantityInput);
    
                                const priceInput = document.createElement('input');
                                priceInput.type = 'number';
                                priceInput.name = `${accountName}_price`;
                                priceInput.id = `price_${index}`;
                                priceInput.value = 0;
                                priceInput.step = '0.01';
                                priceInput.required = true;
                                priceInput.oninput = () => calculateTotal(index);
                                priceCell.appendChild(priceInput);
    
                                const totalSpan = document.createElement('span');
                                totalSpan.id = `total_${index}`;
                                totalSpan.textContent = '0.00';
                                totalCell.appendChild(totalSpan);
    
                                const balanceSpan = document.createElement('span');
                                balanceSpan.id = `balance_${index}`;
                                balanceSpan.textContent = "$" + (accountInfoDict[accountName].securitiesAccount.currentBalances.cashBalance || '0.00');
                                balanceCell.appendChild(balanceSpan);
    
                                row.appendChild(quantityCell);
                                row.appendChild(priceCell);
                                row.appendChild(totalCell);
                                row.appendChild(balanceCell);
                                table.appendChild(row);
    
                                form.appendChild(table);
                            });
                        })
                        .catch(error => console.error('Failed to fetch account info:', error));
                })
                .catch(error => console.error('Failed to fetch account names:', error));
        }
    
        function calculateTotal(index) {
            const quantity = document.getElementById(`quantity_${index}`).value;
            const price = document.getElementById(`price_${index}`).value;
            const total = (quantity * price).toFixed(2);
            document.getElementById(`total_${index}`).textContent = total;
        }
    
        // On page load, restore the checkbox states and other elements
        document.addEventListener('DOMContentLoaded', function() {
            addCheckboxes();
            addQuantityPriceTables();
            loadOrderTables();
        });
    </script>
</head>
<body onload="addCheckboxes(); addQuantityPriceTables(); loadOrderTables();">
    <h2>Order Form</h2>
    <form action="http://127.0.0.1:5000/order" method="POST" id="orderForm">
        <label for="symbol">Symbol:</label><br>
        <input type="text" id="symbol" name="symbol"><br>
        <label for="order_type">Order Type:</label><br>
        <select id="order_type" name="order_type">
            <option value="LIMIT">LIMIT</option>
            <option value="MARKET">MARKET</option>
        </select><br>
        <label for="instruction">Instruction:</label><br>
        <select id="instruction" name="instruction">
            <option value="BUY">BUY</option>
            <option value="SELL">SELL</option>
        </select><br>
        <br>
        <input type="submit" value="Submit">
    </form>

    <br><br>

    <div id="orderTablesDiv">
        <!-- Order tables will be displayed here -->
    </div>
</body>
</html>
